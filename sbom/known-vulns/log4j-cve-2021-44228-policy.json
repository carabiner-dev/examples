{
    "id": "log4j-cve-2021-44228-policy",
    "meta": {
        "description": "Detects log4j CVE-2021-44228 (Log4Shell) vulnerability in Java SBOM",
        "runtime": "cel@v0",
        "assert_mode": "AND"
    },
    "tenets": [
        {
            "code": "size(predicates) > 0",
            "predicates": {
                "types": ["https://spdx.dev/Document"]
            },
            "assessment": {
                "message": "Found SPDX SBOM"
            },
            "error": {
                "message": "No SPDX SBOM found"
            }
        },
        {
            "code": "!predicates[0].data.packages.exists(pkg, has(pkg.externalRefs) && pkg.externalRefs.exists(ref, ref.referenceType == 'purl' && purl.packageType(ref.referenceLocator) == 'maven' && purl.namespace(ref.referenceLocator) == 'org.apache.logging.log4j' && purl.name(ref.referenceLocator) == 'log4j-core' && (purl.version(ref.referenceLocator).matches('^2\\\\.(0|[1-9]|1[0-4])\\\\..*$') || purl.version(ref.referenceLocator).matches('^2\\\\.0-beta[0-9]$'))))",
            "predicates": {
                "types": ["https://spdx.dev/Document"]
            },
            "assessment": {
                "message": "No vulnerable log4j-core versions detected (CVE-2021-44228)"
            },
            "error": {
                "message": "CRITICAL: Vulnerable log4j-core version detected (CVE-2021-44228 - Log4Shell)",
                "guidance": "Upgrade log4j-core to version 2.15.0 or higher immediately. CVE-2021-44228 is a critical remote code execution vulnerability."
            }
        },
        {
            "code": "!predicates[0].data.packages.exists(pkg, has(pkg.externalRefs) && pkg.externalRefs.exists(ref, ref.referenceType == 'purl' && purl.packageType(ref.referenceLocator) == 'maven' && purl.namespace(ref.referenceLocator) == 'org.apache.logging.log4j' && purl.name(ref.referenceLocator) == 'log4j-core' && (purl.version(ref.referenceLocator).matches('^2\\\\.(0|[1-9]|1[0-4])\\\\..*$') || purl.version(ref.referenceLocator).matches('^2\\\\.0-beta[0-9]$'))))",
            "predicates": {
                "types": ["https://spdx.dev/Document"]
            },
            "outputs": {
                "log4j_core_count": {
                    "code": "size(predicates[0].data.packages.filter(pkg, has(pkg.externalRefs) && pkg.externalRefs.exists(ref, ref.referenceType == 'purl' && purl.packageType(ref.referenceLocator) == 'maven' && purl.namespace(ref.referenceLocator) == 'org.apache.logging.log4j' && purl.name(ref.referenceLocator) == 'log4j-core')))"
                }
            },
            "assessment": {
                "message": "No vulnerable log4j-core package detected"
            },
            "error": {
                "message": "CRITICAL: Vulnerable log4j-core package detected (CVE-2021-44228)",
                "guidance": "Upgrade log4j-core to version 2.15.0 or higher. This is a critical vulnerability affecting log4j-core versions 2.0-beta9 through 2.14.1"
            }
        },
        {
            "code": "predicates[0].data.packages.filter(pkg, has(pkg.externalRefs) && pkg.externalRefs.exists(ref, ref.referenceType == 'purl' && purl.packageType(ref.referenceLocator) == 'maven' && purl.namespace(ref.referenceLocator) == 'org.apache.logging.log4j' && purl.name(ref.referenceLocator) == 'log4j-core')).all(pkg, pkg.externalRefs.filter(ref, ref.referenceType == 'purl' && purl.packageType(ref.referenceLocator) == 'maven' && purl.namespace(ref.referenceLocator) == 'org.apache.logging.log4j' && purl.name(ref.referenceLocator) == 'log4j-core').all(ref, purl.version(ref.referenceLocator).matches('^(2\\\\.(1[5-9]|[2-9][0-9])|[3-9]\\\\.).*$') || purl.version(ref.referenceLocator).matches('^[4-9][0-9]*\\\\..*$')))",
            "predicates": {
                "types": ["https://spdx.dev/Document"]
            },
            "assessment": {
                "message": "All log4j-core packages are using safe versions (>= 2.15.0)"
            },
            "error": {
                "message": "Some log4j-core packages may be using unsafe versions",
                "guidance": "Ensure all log4j-core packages are version 2.15.0 or higher to protect against CVE-2021-44228"
            }
        }
    ]
}
